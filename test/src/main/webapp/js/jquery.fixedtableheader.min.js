/* Copyright (c) 2009 Mustafa OZCAN (http://www.mustafaozcan.net)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * Version: .0.2
 * Requires: jquery.1.3+
 */
jQuery.fn.fixedtableheader = function(options) {
	var settings = jQuery.extend({ // jQuery.extend( target [, object1 ] [,objectN ] )
		headerrowsize : 1, // 这是默认参数
		highlightrow : false,
		highlightclass : "highlight"
	}, 
	options); // 用户设置的参数 如果用户设置参数，会覆盖对应的默认参数
	
	this.each(function(i) {
		var $tbl = $(this);
		var $tblhfixed = $tbl.find("tr:lt(" + settings.headerrowsize + ")"); // 找到要固定表头tr
		var headerelement = "th";
		if ($tblhfixed.find(headerelement).length == 0)
			headerelement = "td"; // 没有th，默认td为表头单元格
		if ($tblhfixed.find(headerelement).length > 0) { // 有th单元格
			$tblhfixed.find(headerelement).each(function() {
				$(this).css("width", $(this).width()); // 设置表头th宽度
			});
			var $clonedTable = $tbl.clone().empty(); // 创建表头表格，即一对完整的table标签
			var tblwidth = GetTblWidth($tbl);
			$("#fixedtableheader"+i).remove();
			$clonedTable.attr("id", "fixedtableheader" + i).css({ // 设置悬浮表头绝对定位的位置
				"position" : "fixed",
				"top" : $tbl.offset().top,
				"left" : $tbl.offset().left
			// .offset(): 获取表格的左边距
			}).append($tblhfixed.clone()).width(tblwidth).hide()
					.appendTo($("body")); // 将表头插入table标签中
			$clonedTable.css("display", "block");
			if (settings.highlightrow) // 鼠标移过高亮
				$("tr:gt(" + (settings.headerrowsize - 1) + ")", $tbl)
						.hover(
								function() {
									$(this).addClass(
											settings.highlightclass);
								},
								function() {
									$(this).removeClass(
											settings.highlightclass);
								});
			$(window).scroll(
					function() { // 当滚动条发生变化时触发scroll事件
						if (jQuery.browser.msie
								&& jQuery.browser.version == "6.0") // IE6.0
							$clonedTable.css({ //
								"position" : "absolute",
								"top" : $(window).scrollTop(),
								"left" : $tbl.offset().left
							});
						else
							$clonedTable.css({
								"position" : "fixed",
								"top" : "0",
								"left" : $tbl.offset().left
										- $(window)
												.scrollLeft()
							})
						var sctop = $(window).scrollTop(); // 页面滚动条向下滚动的高度，也即页面被隐藏的高度
						var elmtop = $tblhfixed.offset().top; // 此时原始表格距离浏览器客户区顶端的高度
						if (sctop > elmtop
								&& sctop <= (elmtop
										+ $tbl.height() - $tblhfixed
										.height()))
							$clonedTable.show(); // 原来的表头被滚动的不可见并且表格主体尚未被滚动出屏幕
						else
							$clonedTable.hide(); //
					});
			$(window).resize(
					function() {
						if ($clonedTable.outerWidth() != $tbl
								.outerWidth()) { // 若悬浮表跟不上resize的变化
							$tblhfixed.find(headerelement).each(
									function(index) { // 重新设置悬浮表头clonedTable每个th/td的宽度
										var w = $(this).width();
										$(this).css("width", w);
										$clonedTable
												.find(headerelement)
												.eq(index).css("width",
														w);
									});
							$clonedTable.width($tbl.outerWidth()); // 设置悬浮表的宽度，注意这里.width()和css('width')的区别
						}
						$clonedTable.css("left", $tbl.offset().left); // jquery中offset是相对于浏览器客户区的相对偏移
					});
		}
	});
	function GetTblWidth($tbl) { // 获取元素宽度（包括padding和border）
		var tblwidth = $tbl.outerWidth();
		return tblwidth;
	}
};